<!DOCTYPE html>
<html>
<head>
<script src="../js/jquery-1.11.1.min.js"></script>
<script src="../js/jquery.cookie-1.4.1.min.js"></script>
<script src="../js/jquery-dateFormat.min.js"></script>
<script type="text/javascript">
/*--------------------------------------------------------------------------*/

$(document).ready(function() {
	clearAlert();
	updateSidebar();
	showPage($.cookie("user"));
});

function clearAlert() {
	$("#alert").hide().html("<a href='javascript:clearAlert()'>clear messages</a>");
}

function alert(msg) {
	var time = $.format.date(new Date(), "HH:mm:ss.SSS");
	$("#alert").show().append("<br>["+time+"] " + msg);
}

/*--------------------------------------------------------------------------*/

const server = "http://localhost:3000"

function updateSidebar() {
	$("#sidebar").html(renderLoginForm());
	$.get(server + "/users", function(users) {
		$("#sidebar").append(renderOtherUsersList(users));
	});
}

function showPage(name) {
	updateProfile(name);
	updateWall(name);
}

function updateProfile(name) {
	if (!name) {
		$("#profile").empty();
	} else {
		$.get(server + "/users/" + name, function(user) {
			$("#profile").html(renderProfile(user))
		});
	}
}

var pollRequest;

function updateWall(name) {
	if (pollRequest) pollRequest.abort();
	if (!name) {
		$("#wall").empty();
	} else if (name == $.cookie("user")) {
		$.get(server + "/users/" + name + "/feed", function(posts) {
			$("#wall").html($.map(posts, renderPost));
			pollFeed(name, posts[0] ? posts[0].time : "0000-00-00T00:00:00.0Z");
		})
	} else {
		$.get(server + "/users/" + name + "/posts", function(posts) {
			$("#wall").html($.map(posts, renderPost));
		})
	}
}

function pollFeed(name, lastKnownTime) {
	pollRequest = $.ajax(server + "/users/" + name + "/feed", {
		data: {"lastKnownTime": lastKnownTime},
		timeout: 30000,
		success: function(posts) {
			$("#wall").prepend($.map(posts, renderPost));
			pollFeed(name, posts[0].time);
		},
		error: function(x,t,m) {
			if (t == "timeout") {
				pollFeed(name, lastKnownTime);
			}
		}
	})
}

/*--------------------------------------------------------------------------*/

function logout() {
	$.removeCookie("user");
	updateSidebar();
	showPage();
}

function login() {
	var name = window.prompt("Login");
	$.ajax(server + "/users/" + name, {
		success: function(user) {
			$.cookie("user", user.name);
			updateSidebar();
			showPage(user.name);
		},
		error: function(x,t,m) {
			alert(x.responseText);
		}
	})
}

function register(name) {
	var name = window.prompt("Register a new user");
	$.ajax(server + "/users", {
		type: "put",
		data: {"name": name},
		success: function(user) {
			$.cookie("user", user.name);
			updateSidebar();
			showPage(user.name);
		},
		error: function(x,t,m) {
			alert(x.responseText);
		}
	})
}

function follow(name) {
	var visitor = $.cookie("user");
	$.ajax(server + "/users/" + visitor + "/following", {
		type: "put", 
		data: {"name": name},
		success: function() { 
			showPage(name) 
		}
	})
}

function unfollow(name) {
	var visitor = $.cookie("user");
	$.ajax(server + "/users/" + visitor + "/following", {
		type: "delete", 
		data: {"name": name},
		success: function() { 
			showPage(name) 
		}
	})
}

function post(body) {
	var visitor = $.cookie("user");
	$.ajax(server + "/users/" + visitor + "/posts", {
		type: "post",
		data: {"body": body},
		success: function() {
			showPage(visitor)
		}
	})
}

/*--------------------------------------------------------------------------*/

function linkify(name) {
	return "<a href=\"javascript:showPage('" + name + "');\">" + name + "</a>"
}

function listify(users) {	
	var items = "";
	$.each(users, function() {
		items += "<li>"+linkify(this)+"</li>";
	});
	return "<ul>" + items + "</ul>";
}

function renderLoginForm() {
	var visitor = $.cookie("user");
	if (visitor) {
		return "You are " + linkify(visitor) + "<br>"
			 + "<a href=\"javascript:logout();\">Logout</a>"
	} else {
		return "<a href=\"javascript:login();\">Login</a><br>"
			 + "<a href=\"javascript:register();\">Register</a>"
	}
}

function renderOtherUsersList(users) {
	var visitor = $.cookie("user");
	var idx = users.indexOf(visitor);
	if (idx != -1) { users.splice(idx, 1); }
	return "<h3>Other users:</h3>"
		 + listify(users);
}

function renderProfile(user) {
	return "<h2>" + user.name + "</h2>"
		 + renderFollowButton(user)
		 + renderPostForm(user)
		 + "<h3>Following:</h3>" + listify(user.following)
		 + "<h3>Followers:</h3>" + listify(user.followers)
}

function renderPostForm(user) {
	var visitor = $.cookie("user");
	if (visitor && visitor == user.name) {	
		return "<form action='#'"
		     + " onSubmit='javascript:post(this.body.value);return false;'>"
	    	 + "<input type=text name=body><br>"
	     	 + "<input type=submit value=Post>"
	     	 + "</form>"
	} else {
		return "";
	}
}

function renderFollowButton(user) {
	var visitor = $.cookie("user");
	if (visitor && user.followers.indexOf(visitor) >= 0) {
		return "<a href=\"javascript:unfollow('"+user.name+"');\">Unfollow</a>";
	} else if (visitor && visitor != user.name) {
		return "<a href=\"javascript:follow('"+user.name+"');\">Follow</a>";
	} else {
		return ""
	}
}

function renderPost(post) {
	return "<div class=post>"
		 + "<b class=author>" + linkify(post.author) + "</b>"
		 + "<i class=time>" + jQuery.format.prettyDate(post.time) + "</i>"
		 + "<p class=body>" + post.body + "</p>"
		 + "</div>"
}
/*--------------------------------------------------------------------------*/
</script>
<style>
body {
	font-family: Lucida Grande;
}

#sidebar {
    float: left;
    width:25%;
}

#profile {
    float:left;
    width:25%;
}

#wall {
    float:left;
    width:50%;
}

.post {
	padding: 5px 5px 5px 5px;
	margin-bottom: 10px;
	background-color: white;
}

.post .author {
	font-size: small;
}

.post .time {
	display: block;
	font-size: small;
	color: gray;
}

.post .body {
	margin: 5px auto;
}

#alert {
	background-color: red;
	margin-bottom: 10px;
	padding: 5px;
}

</style>
</head>
<body>
<div id="alert"></div>
<div id="sidebar"></div>
<div id="profile"></div>
<div id="wall"></div>
</body>
</html>